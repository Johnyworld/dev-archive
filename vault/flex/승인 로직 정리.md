# 승인 로직 정리

### API 문서 링크

POST [time-off-uses/dry-run-for-multiple-bucket](https://flex-dev-dev-gateway.dev.grapeisfruit.com/webjars/swagger-ui/index.html?displayOperationId=true&configUrl=%2Fv3%2Fapi-docs%2Fswagger-config&urls.primaryName=timetrack-v2-time-off#/user-time-off-use-update-dry-run-controller/dryRunToRegisterTimeOffUseForMultipleBucket)
GET [resolved-stages](https://flex-dev-dev-gateway.dev.grapeisfruit.com/webjars/swagger-ui/index.html?displayOperationId=true&configUrl=%2Fv3%2Fapi-docs%2Fswagger-config&urls.primaryName=workflow-v2#/workflow-template-controller/getWorkflowTemplateResolvedTargetStages)
POST [get-stakeholder-users-map](https://flex-dev-dev-gateway.dev.grapeisfruit.com/webjars/swagger-ui/index.html?displayOperationId=true&configUrl=%2Fv3%2Fapi-docs%2Fswagger-config&urls.primaryName=stakeholder-v2#/stakeholder-action-controller/resolveMultipleTargetsToStakeholdersAsMap)
POST [time-off-uses-for-multiple-buckets](https://flex-dev-dev-gateway.dev.grapeisfruit.com/webjars/swagger-ui/index.html?displayOperationId=true&configUrl=%2Fv3%2Fapi-docs%2Fswagger-config&urls.primaryName=timetrack-v2-time-off#/user-time-off-use-update-controller/registerTimeOffUseForMultipleBucket)

## 휴가 승인

### 내 휴가에서 휴가 사용시

1. dry-run을 실행하여 현재 값을 바탕으로 등록이 가능한 휴가인지 체크
	- results.success === true 이면 등록 가능
2. 승인이 필요한 휴가인 경우 승인 Task 생성
	- `ignoreApproval === false && approval.enabled === true` 라면 승인 진행
		- `ignoreApproval` → `hasRegisterPermission && !isMyTimeOff`
		- 휴가를 대신 써주는 경우, 승인 라인을 무시할 수 있다
		- 단, 자기 자신일 경우, 승인 라인을 무시할 수 없음
	- 승인 진행 →
		- get-stakeholder-users-map API 요청하여 resolvedTargets을 가져온다.
		- resolvesTargets.length 가 있으면, 휴가 approvalTask 를 생성한다.
		- 생성한 approvalTask의 taskKey 를 담아서 TT 휴가를 등록한다. → time-off-uses-for-multiple-buckets
3. TT 서버에 승인 요청을 보낸다.

## 근무 승인

### 근무 종료 타각시 승인 발생

1. work-end/dry-run
2. resolved-stages
3. get-stakeholder-users-map
4. approval-task
5. work-end

### 타임라인에서 근무 등록 시 승인 발생

1. work-schedules
2. workflow/tasks/staged
